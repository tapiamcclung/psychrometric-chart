<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart 8</title>
    <style>
        body {
            font-family: "Segoe UI";
            height: 100%;
       }

        #chartdiv {
            width: 90%;
            height: calc(90vh - 30px);
            max-width: 100%;
            margin: auto;
        }
    </style>
</head>
<body>
    <h1>8</h1>
    <div id="chartdiv"></div>

    <script src="psychrolib.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>

    <script>
        //function to construct psychrochart
        const get_psychrochart = altitude => {
            //temperature, rel. humidity array, altitude
            var dryBulb = [0,5,10,15,20,25,30,35,40,45,50];//oC
            //var wetBulb = [0,5,10,15,20,25,30,35,40,45,50];//oC
            //var enthalpy = [0,20,40,60,80,100,120,140,160,180,200];//J/g dry Air
            var relativeHumidity = [0.1,0.2,0.3,0.4,0.5,0.6,0.7,0.8,0.9,1];//%

            //call this function with an altitude value
            if(altitude != 0){
                altitude = altitude;
            } else {
                altitude = 0;
            }

            //Call psychrolib function
            var psychrolib = new Psychrometrics();
            //set unit system - SI
            psychrolib.SetUnitSystem(psychrolib.SI);
            //barometric pressure by altitude
            pressure = psychrolib.GetStandardAtmPressure(altitude);

            var data = [],
                temp;

            //###################### Relative Humidity Lines #################################
            for (var [keyTemp, valueTemp] of Object.entries(dryBulb)) {
                let currentData = {temp: valueTemp};

                for (var [keyHumidity, valueHumidity] of Object.entries(relativeHumidity)) {
                    temp = psychrolib.GetHumRatioFromRelHum(valueTemp, valueHumidity, pressure);
                    currentData[`hum${parseInt(keyHumidity)+1}`] = temp*1000;
                }
                data.push(currentData);
            }
            //###################### Relative Humidity Lines #################################

            return data;
        }

    let psychro = get_psychrochart(0);

    // Create root element
    let root = am5.Root.new("chartdiv");

    // Set themes
    root.setThemes([
        am5themes_Animated.new(root)
    ]);

    // Create chart
    let chart = root.container.children.push(
        am5xy.XYChart.new(root, {
            panX: true,
            panY: true,
            wheelX: "panX",
            wheelY: "zoomXY",
            layout: root.verticalLayout,
            paddingLeft: 5,
            paddingRight: 5,
        })
    );

    // Set colors
/*    chart.set("colors",
        am5.ColorSet.new(root, {
            step: 1,
            colors: [
                am5.color(0xF2AA6B),
                am5.color(0xffffff),
            ]
        })
    );*/

    // Create axes
    let xAxis = chart.xAxes.push(
        am5xy.ValueAxis.new(root, {
            min: 0,
            max: 50,
            strictMinMax: true,
            maxDeviation: 0,
            renderer: am5xy.AxisRendererX.new(root, {
                minGridDistance: 100,
                minorGridEnabled: true,
                stroke: am5.color(0x767d84),
                strokeOpacity: 1,
                strokeWidth: 1
            }),
            tooltip: am5.Tooltip.new(root, {
                themeTags: ["axis"],
                animationDuration: 300
            })
        })
    );

    xAxis.children.push(am5.Label.new(root, {
        text: 'Dry Bulb Temperature (Â°C)',
        textAlign: 'center',
        x: am5.p50
      }));

    let yAxis = chart.yAxes.push(
        am5xy.ValueAxis.new(root, {
            min: 0,
            max: 32, // 100
            strictMinMax: true,
            maxDeviation: 0,
            renderer: am5xy.AxisRendererY.new(root, {}),
            tooltip: am5.Tooltip.new(root, {
                themeTags: ["axis"],
                animationDuration: 300
            })
        })
    );

    let yRenderer = yAxis.get("renderer");
    yRenderer.grid.template.set("forceHidden", true);
    yRenderer.labels.template.set("forceHidden", true);


    let xAxisRH = chart.xAxes.push(
        am5xy.ValueAxis.new(root, {
            min: 33,
            max: 50,
            strictMinMax: true,
            maxDeviation: 0,
            numberFormat: "#.'%'",
            renderer: am5xy.AxisRendererX.new(root, {
                opposite: true,
                minGridDistance: 50,
                stroke: am5.color(0x767d84),
                strokeOpacity: 1,
                strokeWidth: 1
            }),
        })
    );

    let xRendererRH = xAxisRH.get("renderer");
    xRendererRH.grid.template.set("forceHidden", true);
    xRendererRH.labels.template.set("forceHidden", true);

    let yAxisRH = chart.yAxes.push(
        am5xy.ValueAxis.new(root, {
            min: 0,
            max: 32,
            strictMinMax: true,
            maxDeviation: 0,
            numberFormat: "#.'%'",
            renderer: am5xy.AxisRendererY.new(root, {
                opposite: true,
                minGridDistance: 50,
                stroke: am5.color(0x767d84),
                strokeOpacity: 1,
                strokeWidth: 1
            }),
        })
    );

    yAxisRH.children.push(am5.Label.new(root, {
        //text: 'Absolute Humidity (g/kg)',
        text: 'Relative Humidity',
        textAlign: 'center',
        y: am5.p50,
        rotation: 90
      }));

    let yRendererRH = yAxisRH.get("renderer");
    yRendererRH.grid.template.set("forceHidden", true);
    yRendererRH.labels.template.set("forceHidden", true);

    const createRange = (value, axis, label) => {
        var rangeDataItem = axis.makeDataItem({
            value: value
        });

        var range = axis.createAxisRange(rangeDataItem);

        range.get("label").setAll({
            forceHidden: false,
            text: label
        });

        range.get("grid").setAll({
            forceHidden: true,
            strokeOpacity: 0.2,
            location: 1
        });
    }

    // Get chart values for last temperature and calculate labels
    Object.values(psychro.filter(k => k.temp == 50)[0]).filter( v => v != 50).forEach( (v,i) => {
        let label = `${(i+1)*10}%`;
        createRange(v, yAxisRH, label);
    });

    // TODO: calculate x coords of RH lines from 50% to 100% to create labels

    // Create series
    function createSeries(name, field, lineType) {

        var series = chart.series.push(
            am5xy.SmoothedXLineSeries.new(root, {
                name: name,
                xAxis: xAxis,
                yAxis: yAxis,
                valueYField: field,
                valueXField: "temp",
                baseAxis: name == "100%" ? yAxis : xAxis,
                stroke: am5.color(0x767d84),
                fill: am5.color(0xffffff)
                //tooltip: am5.Tooltip.new(root, {})
            })
        );
        if (name == "100%") {
            baseAxis: yAxis,
            series.strokes.template.setAll({
                strokeWidth: 1,
                strokeOpacity: 0.7,
            });
            series.fills.template.setAll({
                fillOpacity: 1,
                visible: true
            });
        } else {
            series.strokes.template.setAll({
                strokeDasharray: [3, 2],
                strokeWidth: 1,
                strokeOpacity: 0.7,
            });
        }

        //series.get("tooltip").label.set("text", "[bold]{name}[/]\n{valueX.formatDate()}: {valueY}")
        series.data.setAll(psychro);
    }

    createSeries("10%", "hum1");
    createSeries("20%", "hum2");
    createSeries("30%", "hum3");
    createSeries("40%", "hum4");
    createSeries("50%", "hum5");
    createSeries("60%", "hum6");
    createSeries("70%", "hum7");
    createSeries("80%", "hum8");
    createSeries("90%", "hum9");
    createSeries("100%", "hum10");

    /*var legend = chart.children.push(am5.Legend.new(root, {}));
    legend.data.setAll(chart.series.values);*/

    </script>

</body>
</html>