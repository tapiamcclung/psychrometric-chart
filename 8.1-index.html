<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart 8.1</title>
    <!-- JavaScript libraries -->
    <script type="text/javascript" src="./libraries/d3.v7.min.js"></script>
    <style>
        body {
            font-family: "Segoe UI";
            height: 100%;
       }

        #chartdiv {
            width: 90%;
            height: calc(90vh - 30px);
            max-width: 100%;
            margin: auto;
        }
        #fileInput {
            width: 500px;
        }
    </style>
</head>
<body>
    <h1>8.1</h1>
    <div>
        <label>Seleccione un archivo .epw:</label>
        <input type="file" id="fileinput" style="width: 200px;">
    </div>
    <div> <h2 id="stationName" style="text-align: center;"></h2> </div>
    <div id="chartdiv"></div>

    <script src="psychrolib.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/index.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/xy.js"></script>
    <script src="https://cdn.amcharts.com/lib/5/themes/Animated.js"></script>

    <script type="module">
        import {flatRollup} from "https://cdn.jsdelivr.net/npm/d3@7/+esm";
        import {epwJson} from "../jscripts/epw2json.js"

        // function to create a range array
        const arrayRange = (start, stop, step) =>
            Array.from(
                { length: (stop - start) / step + 1 },
                (value, index) => parseFloat((start + index * step).toFixed(1))
            );

        //function to get  psychro data
        const get_psychroData = altitude => {
            let dryBulb = arrayRange(0, 50, 0.1);
            let relativeHumidity = arrayRange(0.1, 1, 0.1);

            //call this function with an altitude value
            if(altitude != 0){
                altitude = altitude;
            } else {
                altitude = 0;
            }

            //Call psychrolib function
            let psychrolib = new Psychrometrics();
            //set unit system - SI
            psychrolib.SetUnitSystem(psychrolib.SI);
            //barometric pressure by altitude
            pressure = psychrolib.GetStandardAtmPressure(altitude);

            let data = [],
                temp;

            //###################### Relative Humidity Lines #################################
            for (let [keyTemp, valueTemp] of Object.entries(dryBulb)) {
                let currentData = {temp: valueTemp};

                for (let [keyHumidity, valueHumidity] of Object.entries(relativeHumidity)) {
                    rh = psychrolib.GetHumRatioFromRelHum(valueTemp, valueHumidity, pressure);
                    currentData[`hum${parseInt(keyHumidity)+1}`] = rh*1000;
                }
                data.push(currentData);
            }
            //###################### Relative Humidity Lines #################################

            return data;
        }

        // function to create HR series
        const createSeries = (name, field, lineType) => {
            let series = chart.series.push(
                am5xy.SmoothedXLineSeries.new(root, {
                    name: name,
                    xAxis: xAxis,
                    yAxis: yAxis,
                    valueYField: field,
                    valueXField: "temp",
                    baseAxis: name == "100%" ? yAxis : xAxis,
                    stroke: am5.color(0x767d84),
                    fill: am5.color(0xffffff)
                })
            );
            if (name == "100%") {
                baseAxis: yAxis,
                series.strokes.template.setAll({
                    strokeWidth: 1,
                    strokeOpacity: 0.7,
                });
                series.fills.template.setAll({
                    fillOpacity: 1,
                    visible: true
                });
            } else {
                series.strokes.template.setAll({
                    strokeDasharray: [3, 2],
                    strokeWidth: 1,
                    strokeOpacity: 0.7,
                });
            }
            series.data.setAll(psychroData);
        }

        // function to create data series from epw
        const createDataSeries = (waffle, chartData) => {
            let series = chart.series.push(am5xy.LineSeries.new(root, {
                name: name,
                xAxis: xAxis,
                yAxis: yAxis,
                valueYField: "ah",
                valueXField: "t",
        }));

            series.strokes.template.set("visible", false);
            series.bullets.push(() => {
                var bulletCircle = am5.Circle.new(root, {
                  radius: 2,
                  fill: am5.color("#00F"),
                  fillOpacity: 0.8,
                  layer: 30
                });
                return am5.Bullet.new(root, {
                  sprite: bulletCircle
                });
              });

                // ↓ lo mismo para heatmap (cambiar nombre)
                series.data.setAll(chartData);
                chart.set("psychroSeries", series);
                // series.appear();
                // return series;
        };
        
        //******************** basado de código HeatMap → → https://jsfiddle.net/jt7mrboy/2/  ← de heatmap copy
        const heatmapDataColor = (heatmapp,chartData) => {  // para crear los cuadros de heatmap
            let heatmapData = chart.series.push(am5xy.ColumnSeries.new(root,{
                name: heatmapp,
                xAxis: xAxisWaffle,  // ??
                yAxis: yAxisWaffle,  // ??
                valueYField: "ah",
                valueXField: "t",
                valueField: "n",
                clustered: false,
                calculateAggregates: true, // para dar color degradado
                fill: am5.color("00F"),
            }));

            heatmapData.columns.template.setAll({ //heatmap copy
                tooltipText: "{n}", // muestra la cantidad
                strokeOpacity: 1,
                strokeWidth: 2,
                width: am5.percent(100),
                height: am5.percent(100),
            });

            heatmapData.columns.template.events.on("pointerover", function(event) { //heatmap copy
                let di = event.target.dataItem;
                if (di) {
                    heatLegend.showValue(di.get("value", 0));
                }
            });
                
            heatmapData.events.on("datavalidated", function() { //heatmap copy
                heatLegend.set("startValue", series.getPrivate("valueHigh"));
                heatLegend.set("endValue", series.getPrivate("valueLow"));
            });
                
            heatmapData.set("heatRules", [{ //heatmap copy
                target: series.columns.template,
                min: am5.color("00F"), //mod
                max: am5.color(0xfffb77), //mod
                dataField: "value",
                key: "fill"
            }]);
                
            heatmapData.data.setAll(chartData); // lo mismo para heatmap, mod→series
            chart.set(name, heatmapData); // para agregar template/chart del heatmap
        }; // profe → 'todo debe de ir dentro de ésta llave'
        //********************

        // function to create an axis range
        const createRange = (value, axis, label) => {
            let rangeDataItem = axis.makeDataItem({
                value: value
            });

            let range = axis.createAxisRange(rangeDataItem);

            range.get("label").setAll({
                forceHidden: false,
                text: label
            });

            range.get("tick").set("visible", true);
            range.get("grid").setAll({
                forceHidden: true,
                strokeOpacity: 0.2,
                location: 1
            });
        };

        // function to read epw file
        const readSingleFile = file => {
            let f = file;
            if (f) {
                let r = new FileReader();
                r.onloadstart = e => {
                    document.getElementById("fileinput").innerHTML = "Parsing file...";
                };
                r.onload = e => { // lo lee como archivo
                    let contents = e.target.result,
                        raw = r.result,
                        epw = epwJson(raw); // parsea el archivo epw de json object

                        //let altitude = epw.elevation != undefined ? epw.elevation ? 0;
                        let psychrolib = new Psychrometrics();
                        //set unit system - SI
                        psychrolib.SetUnitSystem(psychrolib.SI);
                        let altitude = 0,
                            pressure = psychrolib.GetStandardAtmPressure(altitude),

                            // convert relative humidity from epw to absolute humidity to plot in chart
                            data = epw.weatherData.map( d => {
                                return {"t":+d[6],
                                        "tFloor": Math.floor(d[6]),
                                        //"ah":+d[8],
                                        "ah": psychrolib.GetHumRatioFromRelHum(+d[6], +d[8]/100, pressure)*1000,
                                        //"ahFloor": Math.floor(d[8]/10)*10}
                                        "ahFloor": Math.floor(psychrolib.GetHumRatioFromRelHum(+d[6], +d[8]/100, pressure)*1000)}
                        }),
                            // sumarize data in  groups of temperature, absolute humidity, and number of observations
                            chartData = flatRollup(data, d => d.length, d => d.tFloor, d => d.ahFloor)
                                .map(d => { return {"t": d[0], "ah":d[1], "n":d[2]} });
                        //console.log(data)
                        // console.log(chartData); //** ver array data en consola **
                        // clean series before adding a new one
                        if (chart.get("psychroSeries")) {
                            // Remove previous series
                            let currentSeries = chart.get("psychroSeries");
                            let data = currentSeries.data.values;
                            chart.series.removeValue(currentSeries);
                        }
                        createDataSeries("psychroPoints", data);

                    //console.log(epw); // monitoreo de archivos en consola
                    //document.getElementById("year").innerHTML = "Año: " + epw.year;
                    document.getElementById("stationName").innerHTML = "Chart for " + epw.stationLocation;
                };
                r.readAsText(f);
            } else {
                alert("Failed to load file");
            }
        };

    let psychroData = get_psychroData(0);

    // get temperature values where 40%-100% RH lines intersect with truncated axis
    let limit40 = Object.values(psychroData.filter(k => k.temp == 50)[0]).filter( v => v != 50)[3];
    let tempTicks = [5,6,7,8,9,10].map( rh => {
        let minTemp = psychroData.filter(k => k[`hum${rh}`] > limit40)[0].temp, // min of values above 40
            maxTemp = psychroData.filter(k => k[`hum${rh}`] < limit40).slice(-1)[0].temp, // max of values below 40
            limitTemp = parseFloat((minTemp + (maxTemp - minTemp)/2).toFixed(2));
        return limitTemp;
    });

        //////////////////////////
    const createRange = (value, axis, label) => {
        let rangeDataItem = axis.makeDataItem({
            value: value
        });

        let range = axis.createAxisRange(rangeDataItem);

        range.get("label").setAll({
            forceHidden: false,
            text: label
        });

        range.get("tick").set("visible", true);
        range.get("grid").setAll({
            forceHidden: true,
            strokeOpacity: 0.2,
            location: 1
        });
    }

    // Create root element ---
    let root = am5.Root.new("chartdiv");

    // Set themes
    root.setThemes([
        am5themes_Animated.new(root)
    ]);

    // Create chart
    let chart = root.container.children.push(
        am5xy.XYChart.new(root, {
            panX: true,
            panY: true,
            wheelX: "panX",
            wheelY: "zoomXY",
            layout: root.verticalLayout,
            paddingLeft: 5,
            paddingRight: 5,
        })
    );

    // Create axes
    let xAxis = chart.xAxes.push(
        am5xy.ValueAxis.new(root, {
            min: 0,
            max: 50,
            strictMinMax: true,
            maxDeviation: 0,
            renderer: am5xy.AxisRendererX.new(root, {
                minGridDistance: 100,
                minorGridEnabled: true,
                stroke: am5.color(0x767d84),
                strokeOpacity: 1,
                strokeWidth: 1
            }),
            tooltip: am5.Tooltip.new(root, {
                themeTags: ["axis"],
                animationDuration: 300
            })
        })
    );

    xAxis.children.push(am5.Label.new(root, {
        text: 'Dry Bulb Temperature (°C)',
        textAlign: 'center',
        x: am5.p50,
    }));

    let xRenderer = xAxis.get("renderer");
    xRenderer.ticks.template.setAll({
        visible: true,
    });

    let yAxis = chart.yAxes.push(
        am5xy.ValueAxis.new(root, {
            min: 0,
            max: 32,
            strictMinMax: true,
            maxDeviation: 0,
            renderer: am5xy.AxisRendererY.new(root, {
                    minGridDistance: 100,
                    minorGridEnabled: true,
                    stroke: am5.color(0x767d84),
                    strokeOpacity: 1,
                    strokeWidth: 0.5,
                    opposite: true,
                    forceHidden: true
            }),
            tooltip: am5.Tooltip.new(root, {
                themeTags: ["axis"],
                animationDuration: 300
            }),
        })
    );

    let yRenderer = yAxis.get("renderer");
    yRenderer.grid.template.set("forceHidden", true);
    yRenderer.labels.template.set("forceHidden", true);


    let xAxisRH = chart.xAxes.push(
        am5xy.ValueAxis.new(root, {
            min: 0,
            max: 50,
            strictMinMax: true,
            maxDeviation: 0,
            numberFormat: "#.'%'",
            renderer: am5xy.AxisRendererX.new(root, {
                opposite: true,
                minGridDistance: 50,
                stroke: am5.color(0x767d84),
                strokeOpacity: 1,
                strokeWidth: 1
            }),
        })
    );

    let xRendererRH = xAxisRH.get("renderer");
    xRendererRH.grid.template.set("forceHidden", true);
    xRendererRH.labels.template.set("forceHidden", true);

    // Place labels for RH lines on top x axis
    tempTicks.forEach( (v, i) => {
        let label = `${(i+5)*10}%`;
        createRange(v, xAxisRH, label);
    });

    // TODO: fix top axis style and remove left portion

    let yAxisRH = chart.yAxes.push(
        am5xy.ValueAxis.new(root, {
            min: 0,
            max: 32,
            strictMinMax: true,
            maxDeviation: 0,
            numberFormat: "#.'%'",
            renderer: am5xy.AxisRendererY.new(root, {
                opposite: true,
                minGridDistance: 50,
                stroke: am5.color(0x767d84),
                strokeOpacity: 1,
                strokeWidth: 1
            }),
        })
    );

    yAxisRH.children.push(am5.Label.new(root, {
        //text: 'Absolute Humidity (g/kg)',
        text: 'Relative Humidity',
        textAlign: 'center',
        y: am5.p50,
        rotation: 90
    }));

    let yRendererRH = yAxisRH.get("renderer");
    yRendererRH.grid.template.set("forceHidden", true);
    yRendererRH.labels.template.set("forceHidden", true);

    // Get chart values for last temperature and calculate labels
    Object.values(psychroData.filter(k => k.temp == 50)[0]).filter( v => v != 50).forEach( (v, i) => {
        let label = `${(i+1)*10}%`;
        createRange(v, yAxisRH, label);
    });

    // Create series
    let relativeHumidity = arrayRange(0.1, 1, 0.1);
    relativeHumidity.forEach( rh => {
        let name = rh.toLocaleString("en", {style: "percent"}),
            field = `hum${rh*10}`;
        createSeries(name, field);
    });

    // Read file and draw chart
        let fileInput = document.getElementById("fileinput"); //obtiene el archivo
        fileInput.onchange = evt => {
            readSingleFile(evt.target.files[0]);
        };

    ////////// ADD WAFFLE //////////
    // Create axes for waffle
    /*----------- x -----------*/
    let xRendererWaffle= am5xy.AxisRendererX.new(root, {
        strokeOpacity: 0,
        minGridDistance: 0,
        minorGridEnabled: true,
        stroke: am5.color(0xffffff),
    });

    xRendererWaffle.grid.template.setAll({
        stroke: am5.color(0xf7f8ff),
        location: 0,
    });
    xRendererWaffle.labels.template.set("forceHidden", true);
        
    let xAxisWaffle = chart.xAxes.push(
        am5xy.CategoryAxis.new(root, {
            categoryField: "x",
            strictMinMax: true,
            maxDeviation: 0,
            renderer: xRendererWaffle,
        })
    );
    
    xRendererWaffle.grid.template.setAll({
            location: 0,
        });
        
    /*----------- y -----------*/
    let yRendererWaffle = am5xy.AxisRendererY.new(root, {
        strokeOpacity: 0.2,
        minGridDistance: 50,
        minorGridEnabled: true,
        opposite: true,
        stroke: am5.color(0xffffff),
    });
        
    yRendererWaffle.grid.template.setAll({
        stroke: am5.color(0xb9bdc5),
        location: 0,
    });
        
    yRendererWaffle.labels.template.set("forceHidden", true);


    let yAxisWaffle = chart.yAxes.push(
        am5xy.CategoryAxis.new(root, {
            categoryField: "y",
            strictMinMax: true,
            maxDeviation: 0,
            renderer: yRendererWaffle,
        })
    );

     // LIMIT AXIS 'X'
     xAxisSquare.data.setAll([
        { x:"0" },
        { x:"1" }, { x:"2" }, { x:"3" }, { x:"4" }, { x:"5" }, { x:"6" }, { x:"7" }, { x:"8" }, { x:"9" }, {x:"10"},
        { x:"11" }, { x:"12" }, { x:"13" }, { x:"14" }, { x:"15" }, { x:"16" }, { x:"17" }, { x:"18" }, { x:"19" }, {x:"20"},
        { x:"21" }, { x:"22" }, { x:"23" }, { x:"24" }, { x:"25" }, { x:"26" }, { x:"27" }, { x:"28" }, { x:"29" }, {x:"30"},
        { x:"31" }, { x:"32" }, { x:"33" }, { x:"34" }, { x:"35" }, { x:"36" }, { x:"37" }, { x:"38" }, { x:"39" }, {x:"40"},
        { x:"41" }, { x:"42" }, { x:"43" }, { x:"44" }, { x:"45" }, { x:"46" }, { x:"47" }, { x:"48" }, { x:"49" }, //{x:"50"},
    ]);
    // LIMIT AXIS 'Y'
    yAxisSquare.data.setAll([
        { x:"0" },
        { y:"1" }, { y:"2" }, { y:"3" }, { y:"4" }, { y:"5" }, { y:"6" }, { y:"7" }, { y:"8" }, { y:"9" }, { y:"10" },
        { y:"11" }, { y:"12" }, { y:"13" }, { y:"14" }, { y:"15" }, { y:"16" }, { y:"17" }, { y:"18" }, { y:"19" }, { y:"20" },
        { y:"21" }, { y:"22" }, { y:"23" }, { y:"24" }, { y:"25" }, { y:"26" }, { y:"27" }, { y:"28" }, { y:"29" }, { y:"30" },
        { y:"31" }, // { y:"32" }, 
    ]);


    // Add Waffle series template
    // function makeSeries(Squares) {
        // let series = chart.series.push(
        const createaWaffSeries = (name, chartData) => {
            let dataSeries = chart.series.push(
                am5xy.ColumnSeries.new(root, {
                    name: Squares,
                    xAxis: xAxisWaffle,
                    yAxis: yAxisWaffle,
                    categoryXField: "t",
                    categoryYField: "ah",
                    valueField: "n",
                    categoryYField: "y",
                    openCategoryYField: "y",
                    categoryXField: "x",
                    openCategoryXField: "x",
                    clustered: false,
                    fill: am5.color("#00F"),
            })
        );
            
        series.columns.template.setAll({
            width: am5.percent(95),
            height: am5.percent(95),
            stroke: am5.color(0xffffff),
        });
            
        series.appear();
        legend.data.push(series);
            
        return series;
    };

    </script>
</body>
</html>
